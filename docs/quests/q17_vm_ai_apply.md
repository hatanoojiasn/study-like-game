# Q17: 敵AIへVMを移植せよ

## 0. ミッション概要
ラボ世界の基幹システムが破損し、学習者の進行率が低下しています。  
今回の任務は「症状を観測し、原因を推理し、最小改修で回復させる」ことです。

## 1. 症状
- 観測現象: 敵の挙動がハードコードで拡張不能。
- 再現手順:
  1. 既定ビルドを起動する。
  2. 60秒程度プレイし、HUD/ログの乱れを記録する。
  3. 同じ操作を3回行い、再現率を確認する。
- ログ例:
```text
[timing] avg=21.4ms min=1ms max=144ms frames=47
[warn] quest=Q17 anomaly_detected=true
```

## 2. なぜ重要か
この障害を放置すると、次のTierで「何が壊れているか」を判定できず、修理時間が指数的に増えます。  
先に可観測性と再現性を確保することが、ゲーム全体の攻略効率を上げる鍵です。

## 3. 目標
- VM命令を敵状態遷移へ接続する。
- 公開API（`platform.h` / `game.h` / `engine.h`）を変更せずに達成する。

## 4. 達成報酬
- 解放能力（アンロック）: **敵AI編集解放**
- 世界の変化: 修理後はHUDや挙動が安定し、次Questの異常原因を短時間で特定できる。

## 5. 受け入れ条件（Definition of Done）
- 定量条件1: 対象メトリクスを30〜300秒観測し、改善前後の差分をログで示せる。  
- 定量条件2: 同一手順を3回実施し、再現率・改善率を100%で示せる。  
- 定量条件3: 公開ヘッダの関数シグネチャに差分がない。

## 6. 失敗例（最低3つ）
1. 体感のみで完了判定し、ログ比較を残していない。  
2. 1回だけ成功した結果で「解決済み」と判断する。  
3. 手早く解決するために公開APIを増やし、将来Questの互換性を壊す。

## 7. 用語ミニ辞典
- **dt**: フレーム間の経過時間。更新安定性の中心指標。  
- **ジッタ**: 時間間隔の揺らぎ。操作感悪化の主因。  
- **決定性**: 同じ入力で同じ結果になる性質。回帰検証に必須。  
- **ヘッドレステスト**: ウィンドウ無しで走る自動テスト。CI向き。  
- **協調スケジューリング**: タスクが自発的に処理を譲る実行方式。  
- **AABB**: 軸平行境界ボックスによる軽量な衝突判定。  
- **バイトコード**: VM向けの中間命令列。

## 8. 実装の方向性
### 8.1 ここからスタート（最初の10分）
- `src/game/game.c` の敵更新相当（未実装なら最小状態機械）を特定する。


### 8.2 編集してよいファイル（推奨）
- `src/game/game.c`
- `src/engine/engine.c`


### 8.3 できれば触らないファイル（理由付き）
- AI用の公開API追加


### 8.4 実装アプローチの選択肢
- 低リスク案: 先にログ観測点を増やし、次に挙動変更する。  
- 高速案: 先に挙動を直し、後で計測を追加する。  
- 推奨: 低リスク案。Q17 は再現性の担保がクリア速度に直結するため。

## 9. テスト計画
- 自動テスト（出発点）:
  - スクリプト差し替えで敵挙動が変化することを確認
  - 決定性テストにAI有効ケースを追加

- 手動テスト: 60秒操作 + 60秒放置を1セットとして3回実施。  
- ログの見方: `[timing]` の avg/min/max と `Q17` の警告ログ有無を比較する。

## 10. 次のクエストにどう繋がるか
この修理で得た安定性は次のQuestの前提装備になります。  
今回の介入（VM命令を敵状態遷移へ接続する。）が、次の難易度段差を1段下げます。
